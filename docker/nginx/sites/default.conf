server {
    listen 80;
    server_name localhost;
    root /var/www/backend/public;
    index index.php index.html index.htm;

    # Headers de Segurança
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # API Backend - Slim Framework
    location /api {
        try_files $uri /index.php$is_args$args;
        
        # Rate limiting para API - 10 requisições por segundo, burst de 20
        limit_req zone=api burst=20 nodelay;
    }

    # Rate limiting mais restritivo para login
    location /api/auth/login {
        try_files $uri /index.php$is_args$args;
        
        # Rate limiting para login - 1 requisição por segundo, burst de 3
        limit_req zone=login burst=3 nodelay;
    }

    # Processamento PHP
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # Frontend Vue.js
    location / {
        root /var/www/frontend;
        try_files $uri $uri/ /index.html;
        
        # Cache para arquivos estáticos
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Segurança - negar arquivos sensíveis
    location ~ /\.(ht|git) { deny all; }
    location ~ /composer\.(json|lock) { deny all; }
    location ~ /package\.(json|lock) { deny all; }

    # Logs personalizados
    error_log /var/log/nginx/hortas_error.log;
    access_log /var/log/nginx/hortas_access.log;
}